<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales report ¬∑ {{ report_date|human_date }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/manager.css') }}">
  <style>
    .report-detail-page {
      max-width: 1100px;
      margin: 2rem auto;
      padding: 0 1.5rem 2rem;
      color: var(--text);
    }
    .report-detail-header {
      margin-bottom: 1.5rem;
    }
    .report-detail-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-bottom: 2rem;
    }
    .report-summary-card {
      padding: 1.25rem;
    }
    .report-summary-card p,
    .report-summary-card .insight-value {
      color: var(--text);
    }
    .report-summary-card .warn {
      color: #fca5a5;
    }
    .report-detail-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      justify-content: space-between;
      gap: 1rem;
    }
    .report-detail-search {
      min-width: 260px;
    }
    .report-detail-search input {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.55rem 0.9rem;
      background: rgba(255,255,255,0.08);
      color: var(--text);
    }
  </style>
</head>
<body class="manager-body">
  <div class="report-detail-page">
    <header class="report-detail-header">
      <div class="detail-actions">
        <a class="btn btn-soft" href="{{ url_for('manager.dashboard') }}">Back to Dashboard</a>
      </div>
      <p class="eyebrow">Sales report</p>
      <h1>{{ shop.name }} ¬∑ {{ report_date|human_date }}</h1>
      <p>Detailed breakdown for this day.</p>
    </header>

    <section class="report-detail-grid">
      <article class="card report-summary-card">
        <p class="muted tiny">Date</p>
        <p class="insight-value">{{ report_date|human_date }}</p>
      </article>
      <article class="card report-summary-card">
        <p class="muted tiny">Total sales</p>
        <p class="insight-value">PKR {{ '%.2f'|format(summary.sales_total) }}</p>
      </article>
      <article class="card report-summary-card">
        <p class="muted tiny">Total returns</p>
        <p class="insight-value">PKR {{ '%.2f'|format(summary.returns_total) }}</p>
      </article>
      <article class="card report-summary-card">
        <p class="muted tiny">Net profit</p>
        {% set net_total = summary.sales_total - summary.returns_total %}
        <p class="insight-value {{ 'warn' if net_total < 0 else '' }}">PKR {{ '%.2f'|format(net_total) }}</p>
      </article>
      <article class="card report-summary-card">
        <p class="muted tiny">Items sold</p>
        <p class="insight-value">{{ summary.sold_items }}</p>
      </article>
    </section>

    <section class="card table-card">
      <div class="card-head report-detail-toolbar">
        <div>
          <h2>Transactions</h2>
          <p class="muted">Detailed list for {{ report_date|human_date }}.</p>
        </div>
        <label class="field report-detail-search">
          <span>Search entries</span>
          <input type="search" id="reportDetailSearch" placeholder="Search by customer, product, or time" autocomplete="off">
        </label>
      </div>
      {% if report_sales %}
        <div class="table-shell">
          <table class="table" id="reportDetailTable">
            <thead>
              <tr>
                <th>Sr.</th>
                <th>Type</th>
                <th>Customer</th>
                <th>Total</th>
                <th>When</th>
                <th>Items</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for block in report_sales %}
                {% set product_names = block.sale_items | map(attribute='product_name') | list %}
                <tr class="report-detail-row"
                    data-customer="{{ (block.sale.customer_name or 'Walk-in customer')|lower }}"
                    data-time="{{ block.sale.created_at|human_time|lower }}"
                    data-products="{{ product_names|join(' ')|lower }}">
                  <td>{{ loop.index }}</td>
                  <td>{{ block.sale.sale_type|capitalize }}</td>
                  <td>{{ block.sale.customer_name or 'Walk-in customer' }}</td>
                  <td>PKR {{ '%.2f'|format(block.sale.total_amount) }}</td>
                  <td>{{ block.sale.created_at|human_datetime }}</td>
                  <td>
                    <ul class="purchase-preview-list">
                      {% for item in block.sale_items %}
                        <li>
                          <span class="purchase-index">{{ loop.index }}.</span>
                          <div class="purchase-date">
                            <strong class="purchase-product">{{ item.product_name }}</strong>
                            {% set returned_qty = item.returned_quantity or 0 %}
                            {% set remaining_qty = item.remaining_quantity or (item.quantity - returned_qty) %}
                            <small class="muted">
                              Qty {{ item.quantity }}
                              {% if returned_qty %}
                                ¬∑ Returned {{ returned_qty }}
                              {% endif %}
                            </small>
                          </div>
                          <strong>{{ item.quantity }} @ PKR {{ '%.2f'|format(item.unit_price) }}</strong>
                          {% if block.sale.sale_type == "sale" %}
                            {% if remaining_qty > 0 %}
                            <button class="btn btn-soft btn-mini return-inline-btn" type="button"
                                    data-return-sale-item
                                    data-sale-id="{{ block.sale.id }}"
                                    data-sale-item='{{ item|tojson|e }}'>
                              Return
                            </button>
                              {% if returned_qty %}
                                <span class="muted tiny">Pending {{ remaining_qty }} left</span>
                              {% endif %}
                            {% else %}
                              <span class="muted tiny">Returned {{ item.returned_at|human_datetime }}</span>
                            {% endif %}
                          {% endif %}
                        </li>
                      {% endfor %}
                    </ul>
                  </td>
                  <td>
                    {% if block.sale.sale_type == "sale" %}
                      <span class="muted tiny">Line actions</span>
                    {% else %}
                      <span class="muted tiny">Return recorded</span>
                      {% if block.sale.reference_created_at %}
                        <button class="btn btn-soft btn-mini info-return-btn" type="button"
                                data-return-info="Purchased: {{ block.sale.reference_created_at|human_datetime }}&#10;Returned: {{ block.sale.created_at|human_datetime }}">
                          Info
                        </button>
                      {% endif %}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="table-pagination" id="reportDetailPagination" hidden>
          <button class="btn btn-soft btn-mini" type="button" id="reportDetailPrevBtn">Previous</button>
          <span class="muted tiny" id="reportDetailPageMeta"></span>
          <button class="btn btn-soft btn-mini" type="button" id="reportDetailNextBtn">Next</button>
        </div>
        <div class="empty mini" id="reportDetailEmpty" hidden>
          <div class="empty-art">üîç</div>
          <p>No transactions match this search.</p>
        </div>
      {% else %}
        <div class="empty mini">
          <div class="empty-art">?</div>
          <p>No transactions recorded for this day.</p>
        </div>
      {% endif %}
    </section>
  </div>

  <div class="modal-backdrop" id="returnSaleModal">
    <div class="modal">
      <div class="modal-head">
        <div>
          <p class="modal-title">Return items</p>
          <p class="modal-sub">Select quantities to return to stock.</p>
        </div>
        <button class="icon-btn" type="button" data-return-modal-close>&times;</button>
      </div>
      <form class="modal-body" method="post" id="returnSaleForm">
        <div id="returnSaleContainer"></div>
        <label class="confirm-return-checkbox">
          <input type="checkbox" id="returnSaleConfirm">
          <span>I confirm these items are being returned by the customer.</span>
        </label>
        <div class="modal-actions">
          <button class="btn btn-soft" type="button" data-return-modal-close>Cancel</button>
          <button class="btn btn-primary" id="confirmReturnBtn" type="submit" disabled>Submit return</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const reportDetailSearch = document.getElementById("reportDetailSearch");
    const reportDetailRows = document.querySelectorAll(".report-detail-row");
    const reportDetailEmpty = document.getElementById("reportDetailEmpty");
    const reportDetailPagination = document.getElementById("reportDetailPagination");
    const reportDetailPrevBtn = document.getElementById("reportDetailPrevBtn");
    const reportDetailNextBtn = document.getElementById("reportDetailNextBtn");
    const reportDetailPageMeta = document.getElementById("reportDetailPageMeta");
    const reportDetailPageSize = 10;
    let reportDetailPage = 1;

    const getReportDetailMatches = ()=>{
      const term = (reportDetailSearch?.value || "").trim().toLowerCase();
      return {
        term,
        matches: Array.from(reportDetailRows).filter(row=>{
          const haystack = `${row.dataset.customer || ""} ${row.dataset.products || ""} ${row.dataset.time || ""}`;
          return !term || haystack.includes(term);
        })
      };
    };

    const filterReportDetailRows = ()=>{
      if(!reportDetailRows.length){
        reportDetailEmpty?.setAttribute("hidden", "hidden");
        return;
      }
      const { term, matches } = getReportDetailMatches();
      const total = matches.length;
      const totalPages = Math.max(1, Math.ceil(total / reportDetailPageSize));
      if(reportDetailPage > totalPages){
        reportDetailPage = totalPages;
      }
      const start = (reportDetailPage - 1) * reportDetailPageSize;
      const end = Math.min(start + reportDetailPageSize, total);

      reportDetailRows.forEach(row=>{
        row.hidden = true;
      });
      matches.slice(start, end).forEach(row=>{
        row.hidden = false;
      });
      if(reportDetailEmpty){
        reportDetailEmpty.hidden = !(total === 0 && term);
      }
      if(reportDetailPageMeta){
        reportDetailPageMeta.textContent = total
          ? `Showing ${start + 1}-${end} of ${total}`
          : "Showing 0 of 0";
      }
      if(reportDetailPrevBtn){
        reportDetailPrevBtn.disabled = reportDetailPage <= 1;
      }
      if(reportDetailNextBtn){
        reportDetailNextBtn.disabled = reportDetailPage >= totalPages;
      }
      if(reportDetailPagination){
        reportDetailPagination.hidden = total <= reportDetailPageSize;
      }
    };

    reportDetailSearch?.addEventListener("input", ()=>{
      reportDetailPage = 1;
      filterReportDetailRows();
    });
    reportDetailPrevBtn?.addEventListener("click", ()=>{
      if(reportDetailPage > 1){
        reportDetailPage -= 1;
        filterReportDetailRows();
      }
    });
    reportDetailNextBtn?.addEventListener("click", ()=>{
      reportDetailPage += 1;
      filterReportDetailRows();
    });
    filterReportDetailRows();

    const saleReturnBase = {{ url_for('manager.sale_return', sale_id=0)|tojson }};
    const returnSaleModal = document.getElementById("returnSaleModal");
    const returnSaleForm = document.getElementById("returnSaleForm");
    const returnSaleContainer = document.getElementById("returnSaleContainer");
    const returnSaleConfirm = document.getElementById("returnSaleConfirm");
    const confirmReturnBtn = document.getElementById("confirmReturnBtn");

    const refreshReturnButtonState = ()=>{
      if(!confirmReturnBtn){
        return;
      }
      const selected = returnSaleContainer?.querySelector(".return-item-toggle:checked");
      confirmReturnBtn.disabled = !(returnSaleConfirm?.checked && selected);
    };

    const normalizeRemainingItems = (items=[])=>{
      return items
        .map(item=>{
          const soldQty = Number(item.quantity) || 0;
          const remaining = Math.min(
            soldQty,
            Math.max(Number(item.remaining_quantity ?? soldQty) || 0, 0)
          );
          return { ...item, __soldQty: soldQty, __remainingQty: remaining };
        })
        .filter(entry=> entry.__remainingQty > 0);
    };

    const openReturnModal = (saleId, saleItemsData, { autoSelect = false } = {})=>{
      if(!returnSaleModal || !returnSaleForm || !returnSaleContainer || !returnSaleConfirm || !confirmReturnBtn){
        return;
      }
      if(!saleId || !saleItemsData.length){
        return;
      }
      const eligibleItems = normalizeRemainingItems(saleItemsData);
      if(!eligibleItems.length){
        alert("All items from this sale have already been returned.");
        return;
      }
      returnSaleForm.action = saleReturnBase.replace("/0/return", `/${saleId}/return`);
      returnSaleContainer.innerHTML = "";
      eligibleItems.forEach(item=>{
        const entryId = `return-item-${item.id}`;
        const soldQty = item.__soldQty;
        const remainingQty = item.__remainingQty;
        const qtyLabel = remainingQty === soldQty
          ? `Return quantity (max ${soldQty})`
          : `Return quantity (left ${remainingQty} of ${soldQty})`;
        const wrapper = document.createElement("div");
        wrapper.className = "batch-entry";
        wrapper.innerHTML = `
          <div class="batch-entry-head">
            <label class="return-select">
              <input type="checkbox" class="return-item-toggle" data-entry="${entryId}">
              <span>${item.product_name}</span>
            </label>
            <input type="hidden" name="return_sale_item_id[]" value="${item.id}" data-return-field="${entryId}" disabled>
            <input type="hidden" name="return_price[]" value="${item.unit_price}" data-return-field="${entryId}" disabled>
          </div>
          <div class="batch-entry-grid">
            <label>
              <span>${qtyLabel}</span>
              <input type="number" name="return_quantity[]" min="1" max="${remainingQty}" value="${remainingQty}" required data-return-field="${entryId}" disabled>
            </label>
            <label>
              <span>Unit price (PKR)</span>
              <input type="number" value="${item.unit_price}" readonly>
            </label>
          </div>
        `;
        returnSaleContainer.appendChild(wrapper);
        const toggle = wrapper.querySelector(".return-item-toggle");
        const toggleFields = checked=>{
          wrapper.querySelectorAll(`[data-return-field="${entryId}"]`).forEach(input=>{
            input.disabled = !checked;
          });
        };
        toggle?.addEventListener("change", ()=>{
          toggleFields(toggle.checked);
          refreshReturnButtonState();
        });
        toggle.checked = autoSelect;
        toggleFields(autoSelect);
      });
      returnSaleConfirm.checked = false;
      refreshReturnButtonState();
      returnSaleModal.classList.add("show");
    };

    document.querySelectorAll("[data-return-sale-item]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const saleId = btn.dataset.saleId;
        const itemData = btn.dataset.saleItem ? JSON.parse(btn.dataset.saleItem) : null;
        if(!itemData){
          return;
        }
        openReturnModal(saleId, [itemData], { autoSelect: true });
      });
    });

    returnSaleConfirm?.addEventListener("change", ()=>{
      refreshReturnButtonState();
    });

    document.querySelectorAll("[data-return-modal-close]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        returnSaleModal?.classList.remove("show");
      });
    });

    returnSaleModal?.addEventListener("click", evt=>{
      if(evt.target === returnSaleModal){
        returnSaleModal.classList.remove("show");
      }
    });

    document.querySelectorAll(".info-return-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const info = btn.dataset.returnInfo || "No history available.";
        alert(info);
      });
    });
  </script>
</body>
</html>
